(require 'json)
(defvar zhengma:data nil
  "")
(setq zhengma:data
      (json-read-file
       (concat
        (file-name-directory load-file-name) "zhengma/zhengma.json")))
(setq zhengma:data (mapcar #'identity zhengma:data))

(defcustom zhengma:host "127.0.0.1"
  "Preview http host."
  :type 'string
  :group 'zhengma)

(defcustom zhengma:port 8882
  "Preview http port."
  :type 'integer
  :group 'zhengma)
(defvar zhengma:web-index nil)
(defvar zhengma:home-path (file-name-directory load-file-name))
(defvar zhengma:preview-file
  (concat zhengma:home-path "zhengma.html"))
(defvar zhengma:current nil
  "")

(defun zhengma:preview-template ()
  "Template."
  (with-temp-buffer
    (insert-file-contents zhengma:preview-file)
    (buffer-string)))
(defun zhengma:open-browser ()
  "Open browser."
  (browse-url (format "http://%s:%s" zhengma:host zhengma:port)))

(defun zhengma:send-preview (num)
  (emacs-preview-rs/web-server-set-content
   zhengma:web-index
   "/get_content"
   (format "<img src=\"%s.png\"/>" num)))

(defun zhengma:start ()
  "Preview init."
  (interactive)
  (unless zhengma:web-index
    (let ((ret
           (emacs-preview-rs/web-server-start
            zhengma:host zhengma:port)))
      (when (> ret 0)
        (setq zhengma:web-index ret)
        (emacs-preview-rs/web-server-set-root
         zhengma:web-index
         (vconcat [] (list (concat zhengma:home-path "zhengma"))))
        (emacs-preview-rs/web-server-set-content
         zhengma:web-index "/" (zhengma:preview-template)))))
  (zhengma:open-browser)
  (zhengma:next-)
  (call-interactively 'zhengma:next))

(defun zhengma:next- ()
  (while (not
          (assoc (cdr (assoc 'index zhengma:current)) zhengma:gen))
    (setq zhengma:current
          (nth (mod (random t) (length zhengma:data)) zhengma:data)))
  (zhengma:send-preview (cdr (assoc 'index zhengma:current))))

(defun zhengma:next (&optional input)
  (interactive "s请输入图示字根: ")
  (if (string-equal-ignore-case
       input
       (or (cdr
            (assoc (cdr (assoc 'index zhengma:current)) zhengma:gen))
           ""))
      (progn
        (setq zhengma:current nil)
        (zhengma:next-))
    (when (functionp 'doom-themes-visual-bell-fn)
      (doom-themes-visual-bell-fn)))
  (call-interactively 'zhengma:next))

;; 很多至至新加的字根
(defvar zhengma:gen
  '(("0" . "A")
    ("1" . "A")
    ("2" . "A")
    ("3" . "Au")
    ;; ("4" . "AR")歹
    ("5" . "Au")
    ("6" . "B")
    ("7" . "B")
    ("8" . "BD")
    ("9" . "Bu")
    ("10" . "BU")
    ("11" . "BE")
    ("12" . "BM")
    ("13" . "BM")
    ("14" . "BO")
    ("15" . "C")
    ("16" . "C")
    ("17" . "CD")
    ("18" . "CF")
    ("19" . "CK")
    ("20" . "CK")
    ("21" . "CK")
    ("22" . "CK")
    ("23" . "CU")
    ("24" . "CU")
    ("25" . "CE")
    ("26" . "CO")
    ("27" . "CO")
    ("28" . "S")
    ("29" . "S")
    ("30" . "SR")
    ("31" . "F")
    ("32" . "F")
    ("33" . "F")
    ("34" . "FS")
    ("35" . "FA")
    ("36" . "FA")
    ("37" . "FB")
    ("38" . "FB")
    ("39" . "FC")
    ("40" . "FF")
    ("41" . "FK")
    ("42" . "P")
    ("43" . "p")
    ("44" . "pS")
    ("45" . "pB")
    ("46" . "pN")
    ("47" . "pN")
    ("48" . "pE")
    ("49" . "pV")
    ("50" . "pV")
    ("51" . "D")
    ("52" . "D")
    ("53" . "Ds")
    ("54" . "Ds")
    ("55" . "DD")
    ("56" . "Dk")
    ("57" . "Du")
    ("58" . "Dy")
    ("59" . "DM")
    ("60" . "DO")
    ("61" . "DQ")
    ("62" . "DQ")
    ("63" . "DQ")
    ("64" . "Dt")
    ("65" . "Dt")
    ("66" . "Dt")
    ("67" . "K")
    ("68" . "K")
    ("69" . "K")
    ("70" . "K")
    ("71" . "Ks")
    ("72" . "Ks")
    ("73" . "Ks")
    ("74" . "Ks")
    ("75" . "Ks")
    ("76" . "KB")
    ("77" . "kf")
    ("78" . "kf")
    ("79" . "ku")
    ("80" . "ku")
    ("81" . "kM")
    ("82" . "kM")
    ("83" . "kM")
    ("84" . "kM")
    ("85" . "kr")
    ;; ("86" . "kt")既的右半边
    ("87" . "u")
    ("88" . "u")
    ("89" . "u")
    ("90" . "us")
    ("91" . "us")
    ("92" . "us")
    ("93" . "uk")
    ("94" . "uu")
    ("95" . "uu")
    ("96" . "uO")
    ("97" . "n")
    ("98" . "n")
    ("99" . "ns")
    ("100" . "ns")
    ("101" . "nu")
    ("102" . "nu")
    ("103" . "e")
    ("104" . "e")
    ("105" . "e")
    ("106" . "e")
    ("107" . "e")
    ("108" . "e")
    ("109" . "es")
    ("110" . "es")
    ("111" . "es")
    ("112" . "eC")
    ("113" . "eu")
    ("114" . "eua")
    ("115" . "eub")
    ("116" . "euc")
    ("117" . "eO")
    ("118" . "eO")
    ("119" . "eO")
    ("120" . "el")
    ("121" . "eV")
    ("122" . "eV")
    ;; ("123" . "eW")党的上面
    ;; ("124" . "eW")党
    ("125" . "y")
    ("126" . "ys")
    ("127" . "ys")
    ("128" . "ys")
    ("129" . "ys")
    ("130" . "ys")
    ("131" . "ys")
    ("132" . "ys")
    ("133" . "ys")
    ("134" . "ys")
    ("135" . "ys")
    ("136" . "ys")
    ("137" . "ys")
    ("138" . "ys")
    ("139" . "ys")
    ("140" . "ys")
    ("141" . "yC")
    ("142" . "yC")
    ("143" . "yu")
    ("144" . "ye")
    ("145" . "ye")
    ("146" . "ye")
    ("147" . "ye")
    ("148" . "yea")
    ("149" . "yy")
    ("150" . "yO")
    ("151" . "yt")
    ("152" . "yW")
    ("153" . "M")
    ("154" . "M")
    ("155" . "M")
    ("156" . "M")
    ("157" . "MA")
    ("158" . "MA")
    ("159" . "MB")
    ("160" . "MB")
    ("161" . "MB")
    ("162" . "MB")
    ("163" . "MC")
    ("164" . "Ms")
    ("165" . "Ms")
    ("166" . "Mf")
    ("167" . "Mp")
    ("168" . "Mp")
    ("169" . "Mk")
    ("170" . "Mu")
    ("171" . "Mu")
    ("172" . "MO")
    ("173" . "Mi")
    ("174" . "h")
    ;; ("175" . "h"); 不常见
    ("176" . "hs")
    ("177" . "hs")
    ("178" . "hs")
    ("179" . "hB")
    ("180" . "hB")
    ("181" . "hB")
    ("182" . "hB")
    ("183" . "hC")
    ("184" . "hu")
    ("185" . "hn")
    ("186" . "hn")
    ("187" . "he")
    ("188" . "hy")
    ("189" . "hy")
    ("190" . "hy") ;;不带勾
    ("191" . "hX")
    ("192" . "O")
    ("193" . "O")
    ("194" . "Os")
    ("195" . "Os")
    ("196" . "Os")
    ("197" . "Ou")
    ("198" . "Ou")
    ("199" . "Or")
    ("200" . "OX")
    ("201" . "OX")
    ("202" . "j")
    ("203" . "j")
    ("204" . "js")
    ("205" . "js")
    ("206" . "js")
    ("207" . "jsa")
    ("208" . "jp")
    ("209" . "jQ")
    ("210" . "jr")
    ("211" . "jV")
    ("212" . "jV")
    ("213" . "ji")
    ("214" . "Q")
    ("215" . "Q")
    ("216" . "Q")
    ("217" . "Qs")
    ("218" . "QM")
    ("219" . "QX")
    ("220" . "Qi")
    ("221" . "t")
    ("222" . "t")
    ("223" . "t")
    ("224" . "ts")
    ("225" . "tk")
    ("226" . "tk")
    ("227" . "tk")
    ("228" . "tk")
    ("229" . "tO")
    ;; ("230" . "te")尔
    ("231" . "tt")
    ("232" . "tt")
    ("233" . "ks")
    ("234" . "tr")
    ("235" . "tr")
    ("236" . "tr")
    ("237" . "tr")
    ("238" . "tr")
    ("239" . "ti")
    ("240" . "ti") ;; 好像少了个包
    ("241" . "tZ")
    ("242" . "tZa")
    ("243" . "tZa")
    ("244" . "r")
    ("245" . "r")
    ("246" . "r")
    ("247" . "r")
    ("248" . "r")
    ("249" . "rf")
    ("250" . "rf")
    ("251" . "rk")
    ("252" . "rk")
    ("253" . "re")
    ("254" . "rO")
    ("255" . "rl")
    ;; ("256" . "rl")立没有下面一横
    ("257" . "ri")
    ;; ("258" . "rt")衣
    ;; ("259" . "rn")高的上半部
    ("260" . "g")
    ("261" . "gs")
    ("262" . "gs")
    ("263" . "gs")
    ("264" . "gd")
    ("265" . "gu")
    ("266" . "gu")
    ("267" . "gy")
    ("268" . "l")
    ("269" . "l")
    ("270" . "ls")
    ("271" . "ls")
    ("272" . "lA")
    ("273" . "lA")
    ("274" . "lA") ;; 带勾
    ("275" . "lB")
    ("276" . "lB")
    ("277" . "lB")
    ("278" . "lB")
    ("279" . "lC")
    ("280" . "lC")
    ("281" . "lC")
    ("282" . "lC")
    ("283" . "lp")
    ("284" . "lO")
    ("285" . "V")
    ("286" . "V")
    ("287" . "Vs")
    ;; ("288" . "V")四点水
    ;; ("289" . "V")四点水
    ("290" . "W")
    ("291" . "W")
    ("292" . "W")
    ("293" . "Ws")
    ("294" . "Ws")
    ("295" . "WM")
    ("296" . "WO")
    ("297" . "Wr")
    ("298" . "Wg")
    ("299" . "re") ;; 永更正
    ("300" . "WW")
    ("301" . "WZ")
    ("302" . "X")
    ("303" . "X")
    ("304" . "X")
    ("305" . "X")
    ("306" . "X")
    ("307" . "X")
    ("308" . "X")
    ("309" . "X")
    ("310" . "XB")
    ("311" . "XB")
    ("312" . "XB")
    ("313" . "XB")
    ("314" . "XB")
    ("315" . "XB")
    ("316" . "Xma") ;; 尹更正
    ("317" . "Xu")
    ("318" . "Xe")
    ("319" . "XM")
    ("320" . "XM")
    ("321" . "XO")
    ("322" . "XO")
    ("323" . "Xr")
    ;; ("324" . "XX");; 予是二级简码了
    ("325" . "Xr")
    ("326" . "Xr")
    ("327" . "Xr")
    ("328" . "i")
    ("329" . "i")
    ("330" . "i")
    ("331" . "i")
    ("332" . "i")
    ("333" . "i")
    ("334" . "i")
    ("335" . "i")
    ("336" . "i")
    ("337" . "i")
    ("338" . "i")
    ("339" . "is")
    ("340" . "isa")
    ("341" . "iA")
    ("342" . "iu")
    ("343" . "iu")
    ("344" . "iM")
    ("345" . "ig")
    ("346" . "ii")
    ("347" . "ii")
    ("348" . "iia")
    ("349" . "iib")
    ("350" . "ii")
    ("351" . "ii")
    ("352" . "iZ")
    ("353" . "iZ")
    ("354" . "Z")
    ("355" . "Z")
    ("356" . "Z")
    ("357" . "Z")
    ("358" . "Z")
    ("359" . "Z")
    ("360" . "Z")
    ("361" . "Z")
    ("362" . "Z")
    ("363" . "Zs")
    ("364" . "Zs")
    ("365" . "Zu")
    ("366" . "Zu")
    ("367" . "Zu")
    ("368" . "Zu")
    ("369" . "Zu")
    ("370" . "ZM")
    ("371" . "ZM")
    ("372" . "ZM")
    ("373" . "Zi")
    ("374" . "Zi")
    ("375" . "Zs")
    ;; ("376" . "Xr")
    ;; ("377" . "ff")
    ;; ("378" . "pO")
    ;; ("379" . "pO")
    ;; ("380" . "rn")
    ;; ("381" . "iM")
    ;; ("382" . "kM")
    )
  "")

(defun zhengma:stop ()
  (interactive)
  (when zhengma:web-index
    (emacs-preview-rs/web-server-stop zhengma:web-index)
    (setq zhengma:web-index nil)))

(provide 'zhengma)
